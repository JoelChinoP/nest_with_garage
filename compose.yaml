services:
  garage:
      image: dxflrs/garage:v2.1.0
      volumes:
        - ./garage.toml:/etc/garage.toml:ro
        - ./garage/garage_meta:/var/garage/meta
        - ./garage/garage_data:/var/garage/data
        - ./garage/snapshots:/var/garage/snapshots
      ports:
        - 3900:3900
        - 3901:3901
        - 3902:3902
        - 3903:3903
      networks: [cross-network]

  cross-node:
      image: node:24-bookworm-slim
      working_dir: /app
      volumes:
        - ./src:/app/src
        - ./package.json:/app/package.json
        - ./package-lock.json:/app/package-lock.json
        - ./nest-cli.json:/app/nest-cli.json
        - ./tsconfig.json:/app/tsconfig.json
        - ./nodemon.json:/app/nodemon.json
        - ./.swcrc:/app/.swcrc
        - ./.env:/app/.env
      command: >
        sh -c "
        npm ci --no-audit --no-fund --legacy-peer-deps && npx nodemon"
      ports:
        - 8900:${APP_PORT:-8900}
      depends_on: [garage]
      networks: [cross-network]

  garage-ui:
    image: khairul169/garage-webui:latest
    volumes:
      - ./garage.toml:/etc/garage.toml:ro
    environment:
      API_BASE_URL: "http://garage:3903"
      S3_ENDPOINT_URL: "http://garage:3900"
      AUTH_USER_PASS: "admin:$$2y$$10$$EFSJVCbj9SettqwmQ2LhxeUfYPZDFLYQQsgjhOjgWsE9osAEzSIPe"
    ports:
      - 3909:3909
    depends_on: [garage]
    networks: [cross-network]

networks:
  cross-network:
    driver: bridge